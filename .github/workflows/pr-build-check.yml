name: PR Build Check

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  vite-build:
    name: Vite Build Check
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üü© Setup Node.js and PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 8 # or your preferred pnpm version

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # or match your project's Node version
          cache: 'pnpm'

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üî® Build Vite App
        id: vite_build
        run: |
          echo "üîç Starting Vite build..."
          if pnpm build; then
            echo "‚úÖ Vite build completed successfully."
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Vite build failed. Please check the logs above."
            echo "build_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ‚úÖ Output Result
        if: success()
        run: |
          echo "üéâ Build succeeded and no errors were found."

      - name: ‚ùå Output Result
        if: failure()
        run: |
          echo "üö® Build failed. Please check the output and fix the issue."

      - name: üí¨ Comment on PR tagging repo owner and PR author
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get PR info
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const prAuthor = pr.data.user.login;
            // Get repo owner
            const repoOwner = context.repo.owner;
            // Compose comment
            const message = `‚úÖ Vite build passed!\n\nThanks @${prAuthor} for your contribution!\n@${repoOwner}, this PR is ready for review.`;
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });

      - name: üí¨ Comment on PR about build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get PR info
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const prAuthor = pr.data.user.login;
            // Get repo owner
            const repoOwner = context.repo.owner;
            // Compose comment
            const message = `‚ùå Vite build failed!\n\n@${prAuthor}, please check the build logs and fix the issues.\n@${repoOwner}, this PR needs attention.`;
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
